## 页面置换算法的概念

### 置换算法的功能和目标

- 功能
    - 当出现缺页异常，需调用新页面而内存已满时，置换算法**选择被置换的物理页面**
- 设计目标
    - 尽可能**减少页面的调入调出次数**
    - 把未来不再访问或短期内不访问的页面调出
- 页面锁定（frame locking）
    - 描述必须常驻内存的逻辑页面
    - 操作系统的关键部分
    - 要求相应速度的代码和数据
    - 页表中的锁定标志位（lock bit）

### 置换算法的评价方法

- 记录进程访问内存的页面轨迹

    - 举例：虚拟地址访问用（页号，位移）表示

        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(3, 0), (1, 9), (4, 1), (2, 1), (5, 3), (2, 0), (1, 9),

        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(2, 4), (3, 1), (4, 8)
        
    - 对应的页面轨迹
    
        3, 1, 4, 2, 5, 2, 1, 2, 3, 4
    
        替换如 c, a, d, b, e, b, a, b, c, d
    
- 评价方法

    - 模拟页面置换行为，记录产生缺页的次数
    - 更少的缺页，更好的性能

### 页面置换算法分类

- 局部页面置换算法
    - 置换页面的选择范围仅限于当前进程占用的物理页面内
    - 最优算法、先进先出算法、最近最久未使用算法
    - 时钟算法、最不常用算法
- 全局页面置换算法
    - 置换页面的选择范围是所有可换出的物理页面
    - 工作集算法、缺页率算法

## 最优算法、先进先出算法和最近最久未使用算法

### 最优页面置换算法（OPT, optional）

- 基本思路
    - 置换在未来最长时间不访问的页面
- 算法实现
    - 缺页时，计算内存中每个逻辑页面的下一次访问时间
    - 选择**未来最长时间不访问的页面**
- 算法特征
    - 缺页最少，是理想情况
    - 实际系统中**无法实现**
    - 无法预测每个页面在下次访问前的等待时间
    - 作为置换算法的性能评价依据
        - 在模拟器上运行某个程序，并记录每一次的页面访问情况
        - 第二遍运行时使用最优算法

### 最优页面置换算法示例

![](img\操作系统 -- 第九讲 页面置换算法-1.png)

时间 5 之所以把 d 替换成 e 是因为在将要用到的进程中，d 是离得最远的

这里缺页次数出现了 2 次

### 先进先出算法（First-In First-Out FIFO）

- 思路
    - 选择在**内存驻留时间最长**的页面进行置换
- 实现
    - 维护一个记录所有位于内存中的逻辑页面链表
    - 链表元素按驻留内存的时间排序，链首最长，链尾最短
    - 出现缺页时，选择链首页面进行置换，新页面加到链尾
- 特征
    - 实现简单
    - 性能较差，调出的页面可能是经常访问的
    - 进程分配物理页面数增加时，缺页并不一定减少（Belady 现象）
    - 很少单独使用

### FIFO

![](img\操作系统 -- 第九讲 页面置换算法-2.png)

入栈顺序是 `a → b → c → d`，所以替换流程如下

- 替换 a 为 e，此时 e 入栈
- 替换 b 为 a，此时 a 入栈
- 替换 c 为 b，此时 b 入栈
- 替换 d 为 c，此时 c 入栈
- 替换 e 为 d，此时 d 入栈

这里缺页出现了 5 次，从而可见最优页面置换算法的优越性

### 最近最久未使用算法（Least Recently Used, LRU）

- 思路
    - 选择**最长时间没有被引用**的页面进行置换
    - 如某些页面长时间未被访问，则它们在将来还可能会长时间不会访问
- 实现
    - 缺页时，计算内存中每个逻辑页面的**上一次**访问时间
    - 选择**上一次使用到当前时间最长的页面**
- 特征
    - 最优置换算法的一种近似

### 最近最未被使用算法(LRU)

![](img\操作系统 -- 第九讲 页面置换算法-3.png)

每次找每个元素最近一次出现的时间，时间最小的那个被替换

### LRU 算法的可能实现方法

- 页面链表
    - 系统维护一个按最近一次访问时间排序的页面链表
        - 链表首节点是最近刚刚使用过的页面
        - 链表尾节点是最久未使用的页面
    - 访问内存时，找到相应页面，并把它移到链表之首
    - 缺页时，置换链表尾节点的页面
- 活动页面栈
    - 访问页面时，将此页号压入栈顶，并将栈内相同的页号抽出
    - 缺页时，置换栈底的页面
- 特征
    - 开销比较大

### 用栈实现 LRU 算法

![](img\操作系统 -- 第九讲 页面置换算法-4.png)

也是拿栈来实现，不过这里是按访问请求的元素进行压栈，缺页时就置换掉栈底的页面